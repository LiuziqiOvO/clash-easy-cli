#!/bin/bash

# Clash for Linux ç»Ÿä¸€ç®¡ç†å·¥å…·
# ä½œè€…: AI Assistant
# ç‰ˆæœ¬: 1.0.0

# è·å–è„šæœ¬å·¥ä½œç›®å½•ç»å¯¹è·¯å¾„
export SCRIPT_DIR=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local missing_deps=()
    
    # æ£€æŸ¥å¿…éœ€çš„å‘½ä»¤
    for cmd in curl wget; do
        if ! command -v $cmd &> /dev/null; then
            missing_deps+=($cmd)
        fi
    done
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        log_error "ç¼ºå°‘å¿…éœ€çš„ä¾èµ–: ${missing_deps[*]}"
        log_info "è¯·å®‰è£…ç¼ºå°‘çš„ä¾èµ–åé‡è¯•"
        return 1
    fi
    
    # æ£€æŸ¥å¯é€‰ä¾èµ–
    if ! command -v jq &> /dev/null; then
        log_warn "jq æœªå®‰è£…ï¼Œå»¶è¿Ÿæµ‹è¯•å’ŒèŠ‚ç‚¹é€‰æ‹©åŠŸèƒ½å°†ä¸å¯ç”¨"
        log_info "å®‰è£…æ–¹æ³•: sudo apt-get install jq (Ubuntu/Debian) æˆ– sudo yum install jq (CentOS/RHEL)"
    fi
    
    return 0
}

# è·å–ClashçŠ¶æ€
get_clash_status() {
    local pid=$(ps -ef | grep [c]lash-linux-a | awk '{print $2}')
    if [ -n "$pid" ]; then
        echo "running:$pid"
    else
        echo "stopped"
    fi
}

# è·å–Secret
get_secret() {
    if [ -f "$SCRIPT_DIR/.env" ]; then
        source "$SCRIPT_DIR/.env"
        if [ -n "$CLASH_SECRET" ]; then
            echo "$CLASH_SECRET"
        else
            # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–
            if [ -f "$SCRIPT_DIR/conf/config.yaml" ]; then
                grep "^secret:" "$SCRIPT_DIR/conf/config.yaml" | awk '{print $2}' | tr -d "'"
            fi
        fi
    fi
}

# æ£€æŸ¥Clash APIæ˜¯å¦å¯ç”¨
check_clash_api() {
    local secret=$(get_secret)
    local headers=()
    if [ -n "$secret" ]; then
        headers=(-H "Authorization: Bearer $secret")
    fi
    
    if curl -s -m 3 "${headers[@]}" "http://127.0.0.1:9090" > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo "==================== Clash çŠ¶æ€ ===================="
    
    local status=$(get_clash_status)
    if [[ $status == running:* ]]; then
        local pid=${status#running:}
        log_info "Clash æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­ (PID: $pid)"
        
        # æ£€æŸ¥ç«¯å£
        local ports=(7890 7891 7892 9090)
        local port_status=""
        for port in "${ports[@]}"; do
            if netstat -tln 2>/dev/null | grep -q ":$port "; then
                port_status+="$port:âœ“ "
            else
                port_status+="$port:âœ— "
            fi
        done
        log_info "ç«¯å£çŠ¶æ€: $port_status"
        
        # æ£€æŸ¥API
        if check_clash_api; then
            log_info "Clash API: å¯ç”¨"
            log_info "Dashboard: http://$(hostname -I | awk '{print $1}'):9090/ui"
        else
            log_warn "Clash API: ä¸å¯ç”¨"
        fi
        
        # æ£€æŸ¥ä»£ç†çŠ¶æ€
        if [ -n "$http_proxy" ]; then
            log_info "ç³»ç»Ÿä»£ç†: å·²å¼€å¯ ($http_proxy)"
        else
            log_warn "ç³»ç»Ÿä»£ç†: æœªå¼€å¯"
        fi
    else
        log_warn "Clash æœåŠ¡çŠ¶æ€: æœªè¿è¡Œ"
    fi
    
    echo "=================================================="
}

# è·å–å½“å‰ä»£ç†èŠ‚ç‚¹ä¿¡æ¯
get_current_proxy() {
    local secret=$(get_secret)
    local headers=()
    if [ -n "$secret" ]; then
        headers=(-H "Authorization: Bearer $secret")
    fi
    
    # è·å–å½“å‰é€‰ä¸­çš„ä»£ç†ç»„
    local selector_info=$(curl -s -m 5 "${headers[@]}" "http://127.0.0.1:9090/proxies/%F0%9F%94%B0%20%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9" 2>/dev/null)
    if [ $? -ne 0 ] || [ -z "$selector_info" ]; then
        # å°è¯•å…¶ä»–å¸¸è§çš„ä»£ç†ç»„åç§°
        local common_names=("GLOBAL" "Proxy" "ğŸ”° èŠ‚ç‚¹é€‰æ‹©" "èŠ‚ç‚¹é€‰æ‹©" "ä»£ç†é€‰æ‹©")
        for name in "${common_names[@]}"; do
            local encoded_name=$(printf '%s' "$name" | jq -sRr @uri)
            selector_info=$(curl -s -m 5 "${headers[@]}" "http://127.0.0.1:9090/proxies/$encoded_name" 2>/dev/null)
            if [ $? -eq 0 ] && [ -n "$selector_info" ]; then
                break
            fi
        done
    fi
    
    if [ -n "$selector_info" ] && command -v jq &> /dev/null; then
        echo "$selector_info" | jq -r '.now // "æœªçŸ¥èŠ‚ç‚¹"' 2>/dev/null || echo "æœªçŸ¥èŠ‚ç‚¹"
    else
        echo "æœªçŸ¥èŠ‚ç‚¹"
    fi
}

# æµ‹è¯• Google å»¶è¿Ÿ
test_google_latency() {
    local start_time=$(date +%s%3N)
    local http_code
    
    # é€šè¿‡ä»£ç†æµ‹è¯• Google è¿æ¥
    if [ -n "$http_proxy" ]; then
        http_code=$(curl -o /dev/null -s -m 10 -w "%{http_code}" --proxy "$http_proxy" "http://www.google.com/generate_204" 2>/dev/null)
    else
        http_code=$(curl -o /dev/null -s -m 10 -w "%{http_code}" "http://www.google.com/generate_204" 2>/dev/null)
    fi
    
    local end_time=$(date +%s%3N)
    local latency=$((end_time - start_time))
    
    if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
        echo "${latency}ms"
    else
        echo "è¶…æ—¶"
    fi
}

# æ˜¾ç¤ºä»£ç†ä¿¡æ¯
show_proxy_info() {
    if check_clash_api; then
        local current_proxy=$(get_current_proxy)
        local latency=$(test_google_latency)
        
        echo ""
        log_info "å½“å‰èŠ‚ç‚¹: $current_proxy"
        log_info "Google å»¶è¿Ÿ: $latency"
        echo ""
    fi
}

# Toggle å¼€å…³åŠŸèƒ½
toggle_clash() {
    local status=$(get_clash_status)
    
    if [[ $status == running:* ]]; then
        # å½“å‰è¿è¡Œä¸­ï¼Œæ‰§è¡Œå…³é—­
        echo "ğŸ”„ æ£€æµ‹åˆ° Clash æ­£åœ¨è¿è¡Œï¼Œæ­£åœ¨å…³é—­..."
        stop_clash
    else
        # å½“å‰æœªè¿è¡Œï¼Œæ‰§è¡Œå¼€å¯
        echo "ğŸ”„ æ£€æµ‹åˆ° Clash æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨..."
        if start_clash; then
            # å¯åŠ¨æˆåŠŸåæ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
            show_proxy_info
        fi
    fi
}

# é…ç½®å‘å¯¼
config_wizard() {
    echo "==================== Clash é…ç½®å‘å¯¼ ===================="
    
    # æ£€æŸ¥ç°æœ‰é…ç½®
    if [ -f "$SCRIPT_DIR/.env" ]; then
        source "$SCRIPT_DIR/.env"
        if [ -n "$CLASH_URL" ]; then
            echo "å½“å‰è®¢é˜…åœ°å€: $CLASH_URL"
            read -p "æ˜¯å¦è¦æ›´æ”¹è®¢é˜…åœ°å€? (y/N): " change_url
            if [[ ! $change_url =~ ^[Yy]$ ]]; then
                log_info "ä¿æŒç°æœ‰é…ç½®"
                return 0
            fi
        fi
    fi
    
    # è¾“å…¥æ–°çš„è®¢é˜…åœ°å€
    echo ""
    echo "è¯·è¾“å…¥ Clash è®¢é˜…åœ°å€:"
    echo "æ³¨æ„: è¯·ç¡®ä¿è®¢é˜…åœ°å€æœ‰æ•ˆä¸”å¯è®¿é—®"
    read -p "è®¢é˜…åœ°å€: " new_url
    
    if [ -z "$new_url" ]; then
        log_error "è®¢é˜…åœ°å€ä¸èƒ½ä¸ºç©º"
        return 1
    fi
    
    # éªŒè¯è®¢é˜…åœ°å€
    log_info "æ­£åœ¨éªŒè¯è®¢é˜…åœ°å€..."
    if curl -o /dev/null -L -k -sS --retry 3 -m 10 --connect-timeout 10 -w "%{http_code}" "$new_url" | grep -E '^[23][0-9]{2}$' &>/dev/null; then
        log_info "è®¢é˜…åœ°å€éªŒè¯æˆåŠŸ"
    else
        log_error "è®¢é˜…åœ°å€éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®"
        return 1
    fi
    
    # æ›´æ–°é…ç½®æ–‡ä»¶
    if [ -f "$SCRIPT_DIR/.env" ]; then
        # å¤‡ä»½åŸé…ç½®
        cp "$SCRIPT_DIR/.env" "$SCRIPT_DIR/.env.bak.$(date +%Y%m%d_%H%M%S)"
        # æ›´æ–°URL
        sed -i "s|^export CLASH_URL=.*|export CLASH_URL='$new_url'|" "$SCRIPT_DIR/.env"
    else
        # åˆ›å»ºæ–°é…ç½®æ–‡ä»¶
        cat > "$SCRIPT_DIR/.env" << EOF
# Clash è®¢é˜…åœ°å€
export CLASH_URL='$new_url'
export CLASH_SECRET=''

# è®¾ç½®ä¸º1ä»¥è·³è¿‡è®¢é˜…æ£€æŸ¥å’Œä¸‹è½½
SKIP_SUBSCRIPTION_CHECK=0
EOF
    fi
    
    log_info "é…ç½®å·²ä¿å­˜åˆ° .env æ–‡ä»¶"
    echo "=================================================="
}

# ä¸€é”®å¯åŠ¨
start_clash() {
    echo "==================== å¯åŠ¨ Clash ===================="
    
    # æ£€æŸ¥ä¾èµ–
    if ! check_dependencies; then
        return 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ
    local status=$(get_clash_status)
    if [[ $status == running:* ]]; then
        log_warn "Clash å·²åœ¨è¿è¡Œä¸­"
        show_status
        return 0
    fi
    
    # æ£€æŸ¥é…ç½®
    if [ ! -f "$SCRIPT_DIR/.env" ]; then
        log_warn "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨é…ç½®å‘å¯¼..."
        if ! config_wizard; then
            return 1
        fi
    fi
    
    # æ‰§è¡Œå¯åŠ¨è„šæœ¬
    log_info "æ­£åœ¨å¯åŠ¨ Clash æœåŠ¡..."
    if sudo bash "$SCRIPT_DIR/start.sh"; then
        # è‡ªåŠ¨åŠ è½½ç¯å¢ƒå˜é‡
        if [ -f "/etc/profile.d/clash.sh" ]; then
            source /etc/profile.d/clash.sh
            # è‡ªåŠ¨å¼€å¯ä»£ç†
            proxy_on
            log_info "Clash å¯åŠ¨æˆåŠŸå¹¶å·²å¼€å¯ç³»ç»Ÿä»£ç†"
            
            # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
            sleep 3
            
            # æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹å’Œå»¶è¿Ÿä¿¡æ¯
            show_proxy_info
        else
            log_warn "ç¯å¢ƒå˜é‡æ–‡ä»¶æœªåˆ›å»ºï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ: source /etc/profile.d/clash.sh"
        fi
    else
        log_error "Clash å¯åŠ¨å¤±è´¥"
        return 1
    fi
    
    echo "=================================================="
}

# åœæ­¢æœåŠ¡
stop_clash() {
    echo "==================== åœæ­¢ Clash ===================="
    
    # å…³é—­ç³»ç»Ÿä»£ç†
    if [ -f "/etc/profile.d/clash.sh" ]; then
        source /etc/profile.d/clash.sh
        if command -v proxy_off &> /dev/null; then
            proxy_off
        fi
    fi
    
    # æ‰§è¡Œåœæ­¢è„šæœ¬
    if sudo bash "$SCRIPT_DIR/shutdown.sh"; then
        log_info "Clash å·²åœæ­¢"
    else
        log_error "åœæ­¢ Clash å¤±è´¥"
        return 1
    fi
    
    echo "=================================================="
}

# é‡å¯æœåŠ¡
restart_clash() {
    echo "==================== é‡å¯ Clash ===================="
    
    # æ£€æŸ¥æ˜¯å¦è¿è¡Œ
    local status=$(get_clash_status)
    if [[ $status == running:* ]]; then
        log_info "æ­£åœ¨åœæ­¢ Clash..."
        stop_clash
        sleep 2
    fi
    
    log_info "æ­£åœ¨å¯åŠ¨ Clash..."
    start_clash
    
    echo "=================================================="
}

# å»¶è¿Ÿæµ‹è¯•
test_latency() {
    echo "==================== å»¶è¿Ÿæµ‹è¯• ===================="
    
    # æ£€æŸ¥jqä¾èµ–
    if ! command -v jq &> /dev/null; then
        log_error "å»¶è¿Ÿæµ‹è¯•éœ€è¦ jq å·¥å…·ï¼Œè¯·å…ˆå®‰è£…"
        log_info "å®‰è£…æ–¹æ³•: sudo apt-get install jq (Ubuntu/Debian) æˆ– sudo yum install jq (CentOS/RHEL)"
        return 1
    fi
    
    # æ£€æŸ¥Clashæ˜¯å¦è¿è¡Œ
    if ! check_clash_api; then
        log_error "Clash æœªè¿è¡Œæˆ– API ä¸å¯ç”¨ï¼Œè¯·å…ˆå¯åŠ¨ Clash"
        return 1
    fi
    
    # æ‰§è¡Œå»¶è¿Ÿæµ‹è¯•
    bash "$SCRIPT_DIR/scripts/clash_latency.sh"
    
    echo "=================================================="
}

# èŠ‚ç‚¹é€‰æ‹©
select_proxy() {
    echo "==================== èŠ‚ç‚¹é€‰æ‹© ===================="
    
    # æ£€æŸ¥jqä¾èµ–
    if ! command -v jq &> /dev/null; then
        log_error "èŠ‚ç‚¹é€‰æ‹©éœ€è¦ jq å·¥å…·ï¼Œè¯·å…ˆå®‰è£…"
        log_info "å®‰è£…æ–¹æ³•: sudo apt-get install jq (Ubuntu/Debian) æˆ– sudo yum install jq (CentOS/RHEL)"
        return 1
    fi
    
    # æ£€æŸ¥Clashæ˜¯å¦è¿è¡Œ
    if ! check_clash_api; then
        log_error "Clash æœªè¿è¡Œæˆ– API ä¸å¯ç”¨ï¼Œè¯·å…ˆå¯åŠ¨ Clash"
        return 1
    fi
    
    # è‡ªåŠ¨é…ç½®Secretå¹¶æ‰§è¡ŒèŠ‚ç‚¹é€‰æ‹©
    local secret=$(get_secret)
    if [ -n "$secret" ]; then
        # ä¸´æ—¶ä¿®æ”¹è„šæœ¬ä¸­çš„Secret
        local temp_script="/tmp/clash_proxy_selector_temp.sh"
        sed "s/Secret=\"å¡«å†™Clash Secret\"/Secret=\"$secret\"/" "$SCRIPT_DIR/scripts/clash_proxy-selector.sh" > "$temp_script"
        chmod +x "$temp_script"
        bash "$temp_script"
        rm -f "$temp_script"
    else
        log_error "æ— æ³•è·å– Clash Secretï¼Œè¯·æ£€æŸ¥é…ç½®"
        return 1
    fi
    
    echo "=================================================="
}

# å¼€å¯ä»£ç†
enable_proxy() {
    if [ -f "/etc/profile.d/clash.sh" ]; then
        source /etc/profile.d/clash.sh
        if command -v proxy_on &> /dev/null; then
            proxy_on
        else
            log_error "ä»£ç†å‡½æ•°æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå¯åŠ¨ Clash"
        fi
    else
        log_error "ç¯å¢ƒå˜é‡æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå¯åŠ¨ Clash"
    fi
}

# å…³é—­ä»£ç†
disable_proxy() {
    if [ -f "/etc/profile.d/clash.sh" ]; then
        source /etc/profile.d/clash.sh
        if command -v proxy_off &> /dev/null; then
            proxy_off
        else
            log_error "ä»£ç†å‡½æ•°æœªæ‰¾åˆ°"
        fi
    else
        log_error "ç¯å¢ƒå˜é‡æ–‡ä»¶æœªæ‰¾åˆ°"
    fi
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    cat << EOF
Clash for Linux ç»Ÿä¸€ç®¡ç†å·¥å…·

ç”¨æ³•: clash <å‘½ä»¤> [é€‰é¡¹]

å‘½ä»¤:
  start      å¯åŠ¨ Clash æœåŠ¡ (åŒ…å«è‡ªåŠ¨å¼€å¯ç³»ç»Ÿä»£ç†)
  stop       åœæ­¢ Clash æœåŠ¡ (åŒ…å«å…³é—­ç³»ç»Ÿä»£ç†)
  restart    é‡å¯ Clash æœåŠ¡
  status     æ˜¾ç¤º Clash è¿è¡ŒçŠ¶æ€
  config     é…ç½®å‘å¯¼ (è®¾ç½®è®¢é˜…åœ°å€ç­‰)
  test       æµ‹è¯•æ‰€æœ‰ä»£ç†èŠ‚ç‚¹å»¶è¿Ÿ
  select     é€‰æ‹©ä»£ç†èŠ‚ç‚¹å’Œæ¨¡å¼
  on         å¼€å¯ç³»ç»Ÿä»£ç†
  off        å…³é—­ç³»ç»Ÿä»£ç†
  help       æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  clash start          # ä¸€é”®å¯åŠ¨ Clash å¹¶å¼€å¯ä»£ç†
  clash status         # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
  clash config         # é…ç½®è®¢é˜…åœ°å€
  clash test           # æµ‹è¯•èŠ‚ç‚¹å»¶è¿Ÿ
  clash select         # é€‰æ‹©ä»£ç†èŠ‚ç‚¹

æ³¨æ„:
- é¦–æ¬¡ä½¿ç”¨è¯·å…ˆè¿è¡Œ 'clash config' é…ç½®è®¢é˜…åœ°å€
- å»¶è¿Ÿæµ‹è¯•å’ŒèŠ‚ç‚¹é€‰æ‹©åŠŸèƒ½éœ€è¦å®‰è£… jq å·¥å…·
- éƒ¨åˆ†æ“ä½œéœ€è¦ sudo æƒé™

é¡¹ç›®åœ°å€: https://github.com/Elegycloud/clash-for-linux-backup
EOF
}

# ä¸»å‡½æ•°
main() {
    case "${1:-help}" in
        start)
            start_clash
            ;;
        stop)
            stop_clash
            ;;
        restart)
            restart_clash
            ;;
        status)
            show_status
            ;;
        config)
            config_wizard
            ;;
        test)
            test_latency
            ;;
        select)
            select_proxy
            ;;
        on)
            enable_proxy
            ;;
        off)
            disable_proxy
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@" 